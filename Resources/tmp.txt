import telebot
import os
import subprocess

# Set up your bot using your bot token
bot = telebot.TeleBot('6259149794:AAGmRnVUJ-OvvHSLsKmvPmUIk6T642jreWY')
# Check if bot is connected
try:
    bot_info = bot.get_me()
    print('Bot is connected:', bot_info.first_name, bot_info.last_name)
except Exception as e:
    print('Bot is not connected:', e)


def read_commands():
    with open('/Users/monkey/Public/Python/Python_Bot/Resources/Commands.txt', 'r') as f:
        commands = f.read().splitlines()
    return commands


# Define your button labels
button1_label = "List of commands"
button2_label = "Get GitHub Stat"
menu_button_label = "Menu"

# Define your button payloads
button1_payload = "button1"
button2_payload = "button2"
menu_button_payload = "menu_button"

# Define your reply keyboard markup with buttons
keyboard1 = telebot.types.InlineKeyboardMarkup(row_width=2)
button1 = telebot.types.InlineKeyboardButton(button1_label, callback_data=button1_payload)
button2 = telebot.types.InlineKeyboardButton(button2_label, callback_data=button2_payload)
keyboard1.add(button1, button2)

keyboard2 = telebot.types.InlineKeyboardMarkup(row_width=1)
menu_button = telebot.types.InlineKeyboardButton(menu_button_label, callback_data=menu_button_payload)
keyboard2.add(menu_button)


# Send a message with the first keyboard to the user
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "Welcome to Stat Bot! Choose an action:", reply_markup=keyboard1)


# Handle button taps
@bot.callback_query_handler(func=lambda call: True)
def handle_button_tap(call):
    if call.data == button1_payload:
        commands = read_commands()
        bot.send_message(call.message.chat.id, '\n'.join(commands), reply_markup=keyboard2)
    elif call.data == button2_payload:
        bot.send_message(call.message.chat.id, "Please enter a valid GitHub link:", reply_markup=keyboard2)
        bot.register_next_step_handler(call.message, get_github_link)
    elif call.data == menu_button_payload:
        bot.send_message(call.message.chat.id, "\tMenu!\n Choose an action:", reply_markup=keyboard1)
        bot.edit_message_reply_markup(chat_id=call.message.chat.id,
                                      message_id=call.message.message_id,
                                      reply_markup=None)
    else:
        bot.send_message(call.message.chat.id, "Unknown button tapped.")


# Get the GitHub link from the user
def get_github_link(message):
    github_link = message.text
    if github_link.startswith("https://github.com/") or github_link.startswith("github.com/"):
        # Run the parsing.py script and capture its output
        output = subprocess.check_output(['python', 'parsing.py', github_link]).decode()
        # Send the output as a message
        bot.send_message(message.chat.id, output, reply_markup=keyboard2)
    else:
        bot.send_message(message.chat.id,
                         "Please enter a valid GitHub link starting with 'https://github.com/' or 'github.com/'",
                         reply_markup=keyboard2)
        bot.register_next_step_handler(message, get_github_link)


@bot.message_handler(commands=['clear'])
def clear_chat(message):
    # Check if the message is sent in a group or channel
    if message.chat.type in ['group', 'supergroup', 'channel']:
        # Delete all messages in the chat except for the command message
        messages = bot.history(chat_id=message.chat.id, limit=None)
        for m in messages:
            if m.message_id != message.message_id:
                bot.delete_message(chat_id=message.chat.id, message_id=m.message_id)
    # If the message is sent in a private chat, send a message that the command is not applicable
    else:
        bot.send_message(chat_id=message.chat.id, text="This command can only be used in a group or channel.")


# Start the bot
bot.polling()
